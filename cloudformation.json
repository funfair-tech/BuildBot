{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "BuildBot",
  "Parameters": {
    "ApplicationName": {
      "Type": "String"
    },
    "ApplicationContainer": {
      "Type": "String"
    },
    "ApplicationVersion": {
      "Type": "String"
    },
    "Debug": {
      "Type": "String",
      "Default": "True"
    },
    "ECSClusterName": {
      "Type": "String",
      "Default": "DiscordBots"
    },
    "SecurityGroupIDs": {
      "Type": "CommaDelimitedList",
      "Default": "sg-e3e65a9a,sg-0272027302777cb4d"
    },
    "SubnetIDs": {
      "Type": "CommaDelimitedList",
      "Default": "subnet-fabb50b3,subnet-d5ea03b2,subnet-c68aa09e"
    },
    "VpcID": {
      "Type": "String",
      "Default": "vpc-ad3bd9ca"
    },
    "LoadBalancerArn": {
      "Type": "String",
      "Default": "arn:aws:elasticloadbalancing:eu-west-1:117769150821:listener/app/testing/c383c5dd580a74f5/e82083ed48688c7a"
    },
    "LoadBalancerHostName": {
      "Type": "String"
    },
    "LoadBalancerPriority": {
      "Type": "Number"
    },
    "ContainerPort": {
      "Type": "Number",
      "Default": "8080"
    },
    "TaskDefinitionCPU": {
      "Type": "String",
      "Default": "256"
    },
    "TaskDefinitionMemory": {
      "Type": "String",
      "Default": "1024"
    },
    "TaskRole": {
      "Type": "String",
      "Default": ""
    },
    "TaskExecutionRole": {
      "Type": "String",
      "Default": "arn:aws:iam::117769150821:role/ecsTaskExecutionRole"
    },
    "ApiPrefix": {
      "Type": "String"
    },
    "DesiredCount": {
      "Type": "Number",
      "Default": "1"
    },
    "MinimumHealthPercent": {
      "Type": "Number",
      "Default": "100"
    },
    "MaximumHealthPercent": {
      "Type": "Number",
      "Default": "200"
    },
    "AwsContainerRegistry": {
      "Type": "String",
      "Default": "117769150821.dkr.ecr.eu-west-1.amazonaws.com"
    },
    "SecretsManagerArn": {
      "Type": "String",
      "Default": "arn:aws:secretsmanager:eu-west-1:117769150821:secret:BuildBot-ph1YIJ"
    }
  },
  "Resources": {
    "TaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Essential": true,
            "Image": {
              "Fn::Sub": [
                "117769150821.dkr.ecr.eu-west-1.amazonaws.com/funfair/${ApplicationContainer}:${Version}",
                {
                  "Container": {
                    "Ref": "ApplicationContainer"
                  },
                  "Version": {
                    "Ref": "ApplicationVersion"
                  }
                }
              ]
            },
            "Name": { "Ref": "ApplicationName" },
            "ResourceRequirements": [],
            "EnvironmentFiles": [],
            "Environment": [
              {
                "Name": "DISCORD__TOKEN",
                "Value": {
                  "Fn::Sub": [
                    "{{resolve:secretsmanager:${SecretsManagerArn}:SecretString:${Key}}}",
                    { "SecretsManagerArn": { "Ref": "SecretsManagerArn" }, "Key": "DISCORD_TOKEN" }
                  ]
                }
              },
              {
                "Name": "DISCORD__SERVER",
                "Value": {
                  "Fn::Sub": [
                    "{{resolve:secretsmanager:${SecretsManagerArn}:SecretString:${Key}}}",
                    { "SecretsManagerArn": { "Ref": "SecretsManagerArn" }, "Key": "DISCORD_SERVER" }
                  ]
                }
              },
              {
                "Name": "DISCORD__CHANNEL",
                "Value": {
                  "Fn::Sub": [
                    "{{resolve:secretsmanager:${SecretsManagerArn}:SecretString:${Key}}}",
                    {
                      "SecretsManagerArn": { "Ref": "SecretsManagerArn" },
                      "Key": "DISCORD_CHANNEL"
                    }
                  ]
                }
              },
              {
                "Name": "DISCORD__RELEASECHANNEL",
                "Value": {
                  "Fn::Sub": [
                    "{{resolve:secretsmanager:${SecretsManagerArn}:SecretString:${Key}}}",
                    {
                      "SecretsManagerArn": { "Ref": "SecretsManagerArn" },
                      "Key": "DISCORD_RELEASE_CHANNEL"
                    }
                  ]
                }
              }
            ],
            "DisableNetworking": false,
            "DnsServers": [],
            "DnsSearchDomains": [],
            "ExtraHosts": [],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Fn::Sub": ["/ecs/${Path}/", { "Path": { "Ref": "ApplicationName" } }]
                },
                "awslogs-region": "eu-west-1",
                "awslogs-stream-prefix": "ecs"
              }
            },
            "PortMappings": [
              {
                "ContainerPort": { "Ref": "ContainerPort" },
                "HostPort": { "Ref": "ContainerPort" },
                "Protocol": "tcp"
              }
            ],
            "HealthCheck": {
              "Command": ["CMD-SHELL", "/bin/sh /usr/src/app/healthcheck"],
              "Interval": "5",
              "Retries": "3",
              "StartPeriod": "5",
              "Timeout": "2"
            },
            "StartTimeout": "15",
            "StopTimeout": "15"
          }
        ],
        "Family": {
          "Ref": "ApplicationName"
        },
        "Cpu": {
          "Ref": "TaskDefinitionCPU"
        },
        "Memory": {
          "Ref": "TaskDefinitionMemory"
        },
        "ExecutionRoleArn": {
          "Ref": "TaskExecutionRole"
        },
        "TaskRoleArn": {
          "Ref": "TaskRole"
        },
        "RequiresCompatibilities": ["FARGATE"],
        "NetworkMode": "awsvpc",
        "Volumes": [],
        "Tags": [
          {
            "Key": "Network",
            "Value": "avalanche"
          }
        ],
        "RuntimePlatform": {
          "CpuArchitecture": "ARM64",
          "OperatingSystemFamily": "LINUX"
        }
      }
    },
    "LogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": ["/ecs/${Path}/", { "Path": { "Ref": "ApplicationName" } }]
        }
      }
    },
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Name": {
          "Ref": "ApplicationName"
        },
        "Cluster": {
          "Ref": "ECSClusterName"
        },
        "TaskDefinition": {
          "Ref": "TaskDefinition"
        },
        "DesiredCount": {
          "Ref": "DesiredCount"
        },
        "EnableECSManagedTags": false,
        "Tags": [],
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": { "Ref": "SecurityGroupIDs" },
            "Subnets": { "Ref": "SubnetIDs" }
          }
        },
        "DeploymentConfiguration": {
          "MaximumPercent": {
            "Ref": "MaximumHealthPercent"
          },
          "MinimumHealthyPercent": {
            "Ref": "MinimumHealthPercent"
          }
        },
        "LoadBalancers": [
          {
            "ContainerName": { "Ref": "ApplicationName" },
            "ContainerPort": { "Ref": "ContainerPort" },
            "TargetGroupArn": { "Ref": "TargetGroup" }
          }
        ]
      },
      "DependsOn": ["TaskDefinition", "TargetGroup", "ListenerRule"]
    },
    "TargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": {
          "Ref": "ApplicationName"
        },
        "HealthCheckPath": {
          "Fn::Sub": ["${ApiPrefix}/ping?source=target-group", { "ApiPrefix": { "Ref": "ApiPrefix" } }]
        },
        "Port": { "Ref": "ContainerPort" },
        "Protocol": "HTTP",
        "TargetType": "ip",
        "HealthCheckEnabled": true,
        "HealthCheckProtocol": "HTTP",
        "HealthCheckPort": { "Ref": "ContainerPort" },
        "HealthCheckTimeoutSeconds": 4,
        "HealthyThresholdCount": 5,
        "HealthCheckIntervalSeconds": 5,
        "VpcId": { "Ref": "VpcID" },
        "TargetGroupAttributes": [
          {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "5"
          }
        ]
      }
    },
    "ListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup"
            }
          }
        ],
        "Conditions": [
          {
            "Field": "host-header",
            "Values": [{ "Ref": "LoadBalancerHostName" }]
          },
          {
            "Field": "path-pattern",
            "Values": [
              {
                "Fn::Sub": ["${ApiPrefix}/*", { "ApiPrefix": { "Ref": "ApiPrefix" } }]
              },
              { "Ref": "ApiPrefix" }
            ]
          }
        ],
        "ListenerArn": { "Ref": "LoadBalancerArn" },
        "Priority": { "Ref": "LoadBalancerPriority" }
      },
      "DependsOn": ["TargetGroup"]
    }
  }
}
